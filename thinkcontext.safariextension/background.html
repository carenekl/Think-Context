<html>
  <head>
  </head>
  <body>
    <script src="jquery-2.0.3.min.js" type="text/javascript"></script>
    <script src="bg-utils.js" type="text/javascript"></script>
    <script src="db.js" type="text/javascript"></script>
    <script>
      var tcversion = '0.96';
    function onRequest(e) {
        var request = e.message;
	var key = request.key;
        var callback = function(r){ e.target.page.dispatchMessage(r.kind,r)};
        var data;
	switch(request.kind){
        case 'optionsChange':
            optionsChange(e.message);
            break;
	case 'restoreOptions':
	    restoreOptions(callback);
	    break;
	case 'link': 
	    tc.lookupResult(key, request, callback);
	    break;
        case 'place':
            tc.lookupPlace(key,request,callback);
	    break;
        case 'places':
            tc.lookupPlaces(request,callback);
	    break;
	case 'sendstat':
            tc.sendStat(request.key);
	    break;
	case 'urlresolve':
	    tc.urlResolve(request, callback);
	    break;
	}
    };

//console.log("background.html");
tc.connectSubvDB();
safari.application.addEventListener("message",onRequest);
setInterval(tc.updateAllTables, 10870000);

var checkOpts = [ 'opt_rush','opt_green','opt_hotel', 'opt_bechdel', 'opt_bcorp', 'opt_roc' ];

function optionsChange(message){
    if(message.reResults == 1){
	tc.removeLocalTableVersion('results');
    }
    if(message.rePlace){
	tc.removeLocalTableVersion('place');
	tc.removeLocalTableVersion('place_data');	    
    }
    for(var i in checkOpts){
	localStorage[checkOpts[i]] = message.opts[checkOpts[i]];
    }
    localStorage['opt_popD'] = message.opts['opt_popD'];

    tc.loadAllTables();
}

function restoreOptions(callback){
    var opts = {};
    for(var i in checkOpts){
	opts[checkOpts[i]] = localStorage[checkOpts[i]];
    }
    opts['opt_popD'] = localStorage['opt_popD'];
    callback({kind: 'restoreOptions',opts:opts});
}

function openOptions(){
    var t = safari.application.activeBrowserWindow.openTab('foreground');
    t.url = safari.extension.baseURI + "options.html";
}
function openUpdate(){
    var t = safari.application.activeBrowserWindow.openTab('foreground');
    t.url = safari.extension.baseURI + "options.html?update";
}
function openInstall(){
    var t = safari.application.activeBrowserWindow.openTab('foreground');
    t.url = safari.extension.baseURI + "options.html?install";
}

safari.extension.settings.addEventListener("change", openOptions, false);

if(!(localStorage.getItem('tcversion') == tcversion)){
    localStorage.setItem('tcversion',tcversion);
    if(localStorage.getItem('resultsversion')){
        tc.simpleSql("drop table reverse");
        tc.simpleSql("drop table source");    
        openUpdate();
      } else {
        openInstall();
    }
}      

    </script>
  </body>
</html>

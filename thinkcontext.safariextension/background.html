<html>
  <head>
  </head>
  <body>
    <script src="jquery-2.0.3.min.js" type="text/javascript"></script>
    <script src="bg-utils.js" type="text/javascript"></script>
    <script src="db.js" type="text/javascript"></script>
    <script>
      var tcversion = '0.93';
    function onRequest(e) {
        var request = e.message;
	var key = request.key;
        var callback = function(r){ e.target.page.dispatchMessage(r.kind,r)};	        var data;
	switch(request.kind){
	case 'link': 
	    tc.lookupResult(key, request, callback);
	    break;
        case 'place':
            tc.lookupPlace(key,request,callback);
	    break;
        case 'places':
            tc.lookupPlaces(request,callback);
	    break;
	case 'sendstat':
            tc.sendStat(request.key);
	    break;
	case 'urlresolve':
	    tc.urlResolve(request, callback);
	    break;
	}
    };

//console.log("background.html");
tc.connectSubvDB();
safari.application.addEventListener("message",onRequest);
setInterval(tc.updateAllTables, 10870000);

function openOptions(){
    var t = safari.application.activeBrowserWindow.openTab('foreground');
    t.url = safari.extension.baseURI + "options.html";
}
function openUpdate(){
    var t = safari.application.activeBrowserWindow.openTab('foreground');
    t.url = safari.extension.baseURI + "options.html?update";
}
function openInstall(){
    var t = safari.application.activeBrowserWindow.openTab('foreground');
    t.url = safari.extension.baseURI + "options.html?install";
}

safari.extension.settings.addEventListener("change", openOptions, false);

if(!(localStorage.getItem('tcversion') == tcversion)){
    localStorage.setItem('tcversion',tcversion);
    if(localStorage.getItem('resultsversion')){
        tc.simpleSql("drop table reverse");
        tc.simpleSql("drop table source");    
        tc.openUpdate();
      } else {
        openInstall();
    }
}      

    </script>
  </body>
</html>
